<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Formation Premiers Secours - Simulateur RCP + DEA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: #0b1c2d;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        #instruction {
            background: #102a44;
            padding: 15px;
            font-size: 18px;
            border-radius: 8px;
            max-width: 700px;
            margin: 0 auto 20px;
            min-height: 60px;
        }
        #scene {
            position: relative;
            width: 320px;
            margin: 20px auto;
        }
        #mannequin {
            width: 100%;
            display: block;
        }
        .zone {
            position: absolute;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .zone.active {
            border: 2px dashed #ffff00;
            background: rgba(255,255,0,0.15);
        }
        .zone.clicked {
            border: 2px solid lime;
            background: rgba(0,255,0,0.2);
        }

        #epaules   { top: 85px;  left: 35px;  width: 250px; height: 60px; }
        #front     { top: 35px;  left: 100px; width: 120px; height: 35px; }
        #menton    { top: 95px;  left: 130px; width: 60px;  height: 35px; }
        #thorax    { top: 195px; left: 75px;  width: 170px; height: 130px; }
        #bouche    { top: 75px;  left: 110px; width: 100px; height: 45px; }

        #dea {
            display: none;
            margin: 30px auto;
            max-width: 420px;
        }
        .electrode {
            width: 70px;
            cursor: grab;
            margin: 12px;
            display: none;
        }
        .dropzone {
            position: absolute;
            border: 2px dashed #666;
            border-radius: 10px;
            background: rgba(255,255,255,0.08);
            transition: all 0.3s;
            display: none;
        }
        .dropzone.valid {
            border: 3px solid #00ff88;
            background: rgba(0,255,136,0.2);
        }
        #zoneClavicule   { top: 175px; left: 55px;  width: 90px; height: 90px; }
        #zoneAxillaire   { top: 255px; left: 155px; width: 90px; height: 90px; }

        #shock {
            padding: 14px 40px;
            font-size: 20px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
            display: none;
        }
        #shock:disabled {
            background: #555;
            cursor: not-allowed;
        }

        #phone {
            display: none;
            margin: 25px auto;
            padding: 20px;
            background: #1e2a38;
            border-radius: 10px;
            max-width: 500px;
        }

        #mic-btn, #mic-btn-phone {
            padding: 10px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 12px 0;
        }

        #mic-status, #mic-status-phone {
            font-size: 16px;
            color: #ffd700;
            margin-top: 8px;
        }

        #score {
            margin-top: 40px;
            font-size: 22px;
            line-height: 1.6;
            display: none;
        }
    </style>
</head>
<body>

<div id="instruction">
    Étape 1 : Évaluez la conscience<br>Cliquez sur les épaules puis parlez au micro ("Monsieur/Madame, ça va ?").
</div>

<div id="scene">
    <img id="mannequin" src="https://i.imgur.com/xIj4UxP.png" alt="Mannequin RCP">

    <div id="epaules"   class="zone active"></div>
    <div id="front"     class="zone"></div>
    <div id="menton"    class="zone"></div>
    <div id="thorax"    class="zone"></div>
    <div id="bouche"    class="zone"></div>

    <div id="zoneClavicule"   class="dropzone"></div>
    <div id="zoneAxillaire"   class="dropzone"></div>
</div>

<div id="phone">
    <p>Appelez les secours :<br>Dites au micro : "Allô, une personne est inconsciente, adresse : [votre adresse], vite !"</p>
    <button id="mic-btn-phone">Parler au micro</button>
    <div id="mic-status-phone"></div>
</div>

<div id="dea">
    <img src="https://i.imgur.com/vVsh9qV.png" width="220" alt="Défibrillateur"><br>
    <button id="dea-power">Allumer le DEA</button><br>
    <img src="https://i.imgur.com/QfpuXdZ.png" class="electrode" draggable="true" id="elec1">
    <img src="https://i.imgur.com/NMdwaYQ.png" class="electrode" draggable="true" id="elec2"><br>
    <button id="shock" disabled>⚡ CHOC</button>
</div>

<div style="margin: 20px;">
    <button id="mic-btn">Parler au micro</button>
    <div id="mic-status"></div>
</div>

<div id="score"></div>

<script>
    let step = 1;
    let compressions = 0;
    let insufflations = 0;
    let electrodesPlaced = 0;
    let compressionStartTime = null;
    let compressionCount = 0;
    let rhythmOk = false;

    let vecClicked = { front: false, menton: false };

    const instruction = document.getElementById("instruction");
    const scoreDiv = document.getElementById("score");
    const deaDiv = document.getElementById("dea");
    const phoneDiv = document.getElementById("phone");
    const shockBtn = document.getElementById("shock");

    // Simulation simple de reconnaissance vocale (car réelle pas toujours fiable dans tous les navigateurs)
    function simulateSpeech(stepExpected, keywords, successMessage) {
        const spoken = prompt("Dites quelque chose au micro (simulation) :").toLowerCase();
        if (keywords.some(k => spoken.includes(k))) {
            alert("Reconnu : OK");
            return true;
        } else {
            alert("Non reconnu. Essayez : " + successMessage);
            return false;
        }
    }

    // Étape 1 : Conscience
    document.getElementById("epaules").onclick = () => {
        if (step !== 1) return;
        if (simulateSpeech(1, ["ça va", "ca va", "vous allez"], "Monsieur/Madame, ça va ?")) {
            step = 2;
            instruction.innerText = "Aucune réponse. Étape 2 : Appelez à l'aide (parlez au micro : 'Au secours !').";
            document.getElementById("epaules").classList.remove("active");
        }
    };

    document.getElementById("mic-btn").onclick = () => {
        if (step === 2) {
            if (simulateSpeech(2, ["secours", "aide"], "Au secours !")) {
                step = 3;
                instruction.innerText = "Étape 3 : VEC - Cliquez d'abord sur le FRONT, puis sur le MENTON.";
                document.getElementById("front").classList.add("active");
                document.getElementById("menton").classList.add("active");
            }
        }
    };

    // Étape 3 : VEC
    document.getElementById("front").onclick = () => {
        if (step !== 3) return;
        vecClicked.front = true;
        document.getElementById("front").classList.add("clicked");
        checkVEC();
    };

    document.getElementById("menton").onclick = () => {
        if (step !== 3) return;
        vecClicked.menton = true;
        document.getElementById("menton").classList.add("clicked");
        checkVEC();
    };

    function checkVEC() {
        if (vecClicked.front && vecClicked.menton) {
            step = 4;
            instruction.innerText = "Pas de respiration. Étape 4 : 30 compressions (cliquez rapidement sur le thorax).";
            document.getElementById("front").classList.remove("active", "clicked");
            document.getElementById("menton").classList.remove("active", "clicked");
            document.getElementById("thorax").classList.add("active");
            compressionStartTime = Date.now();
            compressionCount = 0;
        }
    }

    // Compressions
    document.getElementById("thorax").onclick = () => {
        if (![4, 10].includes(step)) return;

        compressionCount++;
        if (compressionCount === 1) compressionStartTime = Date.now();

        if (compressionCount >= 30) {
            const timeTaken = (Date.now() - compressionStartTime) / 1000;
            const rate = 30 / (timeTaken / 60);
            rhythmOk = rate >= 100 && rate <= 130; // tolérance un peu plus large

            compressionCount = 0;

            if (step === 4) {
                step = 5;
                instruction.innerText = "30 compressions terminées. Faites 2 insufflations (cliquez sur la bouche).";
                document.getElementById("thorax").classList.remove("active");
                document.getElementById("bouche").classList.add("active");
            } else if (step === 10) {
                step = 11;
                instruction.innerText = "Simulation terminée ! Résultats :";
                scoreDiv.style.display = "block";
                scoreDiv.innerHTML = `
                    <strong>Compressions :</strong> ${compressions} (rythme ${rhythmOk ? 'correct' : 'trop lent/rapide'})<br>
                    <strong>Insufflations :</strong> ${insufflations}<br>
                    <strong>Électrodes placées :</strong> ${electrodesPlaced}/2<br><br>
                    <strong style="color:#00ff88">Bravo ! Vous avez terminé la simulation.</strong>
                `;
            }
        }
    };

    // Insufflations
    document.getElementById("bouche").onclick = () => {
        if (step !== 5) return;
        insufflations++;
        if (insufflations >= 2) {
            step = 6;
            instruction.innerText = "2 insufflations réalisées. Étape 6 : Appelez les secours.";
            document.getElementById("bouche").classList.remove("active");
            phoneDiv.style.display = "block";
        }
    };

    // Appel secours (simulé)
    document.getElementById("mic-btn-phone").onclick = () => {
        if (step !== 6) return;
        if (simulateSpeech(6, ["inconscient", "adresse", "secours"], "une personne est inconsciente, adresse...")) {
            phoneDiv.style.display = "none";
            step = 7;
            instruction.innerText = "Secours appelés. Le DEA arrive. Allumez le DEA.";
            deaDiv.style.display = "block";
            document.getElementById("dea-power").style.display = "inline-block";
        }
    };

    // Suite du code DEA (inchangé pour l'instant, mais zones mieux placées)
    document.getElementById("dea-power").onclick = () => {
        if (step !== 7) return;
        document.getElementById("dea-power").style.display = "none";
        document.querySelectorAll(".electrode").forEach(el => el.style.display = "inline");
        document.querySelectorAll(".dropzone").forEach(z => {
            z.style.display = "block";
            z.style.border = "2px dashed #00ccff";
        });
        step = 8;
        instruction.innerText = "DEA allumé. Placez les deux électrodes sur les zones indiquées.";
    };

    // Drag & drop électrodes (simplifié)
    document.querySelectorAll(".electrode").forEach(el => {
        el.ondragstart = ev => ev.dataTransfer.setData("text", el.id);
    });

    document.querySelectorAll(".dropzone").forEach(zone => {
        zone.ondragover = e => { e.preventDefault(); zone.style.background = "rgba(0,200,255,0.3)"; };
        zone.ondragleave = () => zone.style.background = "rgba(255,255,255,0.08)";
        zone.ondrop = e => {
            e.preventDefault();
            const id = e.dataTransfer.getData("text");
            if (document.getElementById(id)) {
                zone.classList.add("valid");
                document.getElementById(id).style.opacity = "0.7";
                electrodesPlaced++;
                if (electrodesPlaced === 2) {
                    step = 9;
                    instruction.innerText = "Électrodes placées. Dites 'Écartez-vous' puis appuyez sur CHOC.";
                    shockBtn.style.display = "block";
                    shockBtn.disabled = false;
                }
            }
        };
    });

    shockBtn.onclick = () => {
        if (step !== 9) return;
        step = 10;
        instruction.innerText = "CHOC délivré ! Reprenez la RCP (30 compressions puis 2 insufflations).";
        shockBtn.disabled = true;
        shockBtn.innerText = "Choc délivré";
        document.getElementById("thorax").classList.add("active");
        compressionStartTime = null;
        compressionCount = 0;
        insufflations = 0;
    };

</script>
</body>
</html>
