<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Simulateur RCP Avanc√©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    margin:0;
    font-family: Arial, sans-serif;
    background:#0b1c2d;
    color:white;
    text-align:center;
}

#top {
    background:#102a44;
    padding:15px;
    font-size:20px;
}

#mannequin {
    position:relative;
    margin:20px auto;
    width:300px;
    height:600px;
    background:linear-gradient(#ccc,#999);
    border-radius:30px;
}

#thorax {
    position:absolute;
    top:220px;
    left:70px;
    width:160px;
    height:120px;
    background:#555;
    border-radius:20px;
    transition:transform 0.1s;
}

#bouche {
    position:absolute;
    top:70px;
    left:110px;
    width:80px;
    height:40px;
    background:#222;
    border-radius:10px;
}

.zone {
    cursor:pointer;
}

#score {
    background:#102a44;
    padding:10px;
    font-size:16px;
}

button {
    padding:10px 20px;
    font-size:18px;
    margin:10px;
    border-radius:10px;
    border:none;
    cursor:pointer;
}

.good { color:#00ff88 }
.bad { color:#ff5555 }

@media (max-width: 800px) {
    body { font-size:22px; }
    #mannequin { width:90%; height:auto; }
}
</style>
</head>

<body>

<div id="top">ü©∫ Simulateur RCP ‚Äì Mode Formation</div>

<button onclick="start()">‚ñ∂Ô∏è D√©marrer la formation</button>

<div id="mannequin">
    <div id="thorax" class="zone"></div>
    <div id="bouche" class="zone"></div>
</div>

<div id="score"></div>

<script>
/* ===================== VARIABLES ===================== */
let step = 0;
let compressions = 0;
let insufflations = 0;
let goodRhythm = 0;
let badRhythm = 0;
let lastCompressionTime = 0;

/* ===================== AUDIO M√âTRONOME ===================== */
let audioCtx = new AudioContext();
let metronomeInterval;

function startMetronome() {
    metronomeInterval = setInterval(() => {
        let osc = audioCtx.createOscillator();
        osc.frequency.value = 800;
        osc.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.05);
    }, 600); // 100/min
}

function stopMetronome() {
    clearInterval(metronomeInterval);
}

/* ===================== MICRO ANALYSE ===================== */
navigator.mediaDevices.getUserMedia({ audio:true }).then(stream => {
    const mic = audioCtx.createMediaStreamSource(stream);
    const analyser = audioCtx.createAnalyser();
    mic.connect(analyser);
    analyser.fftSize = 256;
    const data = new Uint8Array(analyser.frequencyBinCount);

    setInterval(() => {
        analyser.getByteFrequencyData(data);
        let volume = data.reduce((a,b)=>a+b)/data.length;
        window.currentVolume = volume;
    }, 200);
});

/* ===================== D√âMARRAGE ===================== */
function start() {
    step = 1;
    document.getElementById("top").innerText =
        "D√©butez les compressions thoraciques (30).";
    startMetronome();
}

/* ===================== COMPRESSIONS ===================== */
document.getElementById("thorax").onclick = () => {
    if(step !== 1) return;

    let now = Date.now();
    let delta = now - lastCompressionTime;
    lastCompressionTime = now;

    if(delta > 500 && delta < 700) goodRhythm++;
    else badRhythm++;

    compressions++;
    document.getElementById("thorax").style.transform = "scaleY(0.85)";
    setTimeout(()=> {
        document.getElementById("thorax").style.transform = "scaleY(1)";
    },100);

    if(compressions === 30) {
        stopMetronome();
        step = 2;
        document.getElementById("top").innerText =
            "Effectuez 2 insufflations.";
    }
};

/* ===================== INSUFFLATIONS ===================== */
document.getElementById("bouche").onclick = () => {
    if(step !== 2) return;

    if(window.currentVolume > 20) {
        insufflations++;
    }

    if(insufflations === 2) {
        finish();
    }
};

/* ===================== FIN & SCORE ===================== */
function finish() {
    step = 3;
    let score = Math.round(
        (goodRhythm / (goodRhythm + badRhythm)) * 100
    );

    document.getElementById("top").innerText = "Simulation termin√©e";

    document.getElementById("score").innerHTML = `
        <p class="good">‚úî Compressions : ${compressions}</p>
        <p>‚úî Insufflations : ${insufflations}</p>
        <p>üéµ Rythme correct : ${goodRhythm}</p>
        <p class="bad">‚ö†Ô∏è Rythme incorrect : ${badRhythm}</p>
        <h2>Score global : ${score}%</h2>
        <p>${score > 80 ? "Excellent üëè" : "√Ä am√©liorer üîÅ"}</p>
    `;
}
</script>

</body>
</html>
